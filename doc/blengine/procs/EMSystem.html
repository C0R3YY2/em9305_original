

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EMSystem Procedures &mdash; BLEngine 1.10.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=1d24b1d9"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/js/search.js?v=a5c8da7a"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="authentication Procedures" href="authentication.html" />
    <link rel="prev" title="EM9304commands Procedures" href="EM9304commands.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >

          
          
          <a href="../index.html">
            
              <img src="../_static/logo_h_small.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Getting-Started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Usage.html">CLI Usage and options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Usage.html#blengine-commands">Blengine Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Usage.html#python-module-usage">Python Module Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/NVM-Information.html">NVM Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/HCI-Device-API.html">HCI Device API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Product-Lifecycle.html">Product Lifecycle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Releases-Notes.html">Releases Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/howto/9304.html">9304 Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/howto/9305.html">9305 Examples</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../packets.html">HCI Packets List</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../procedures.html">BLEngine Procedures</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../procedures.html#procedures-references">Procedures references</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="EM9304commands.html">EM9304commands Procedures</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">EMSystem Procedures</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#select-transport-dvk-device">select_transport_dvk_device</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enter-conf-mode">enter_conf_mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#write-hex">write_hex</a></li>
<li class="toctree-l4"><a class="reference internal" href="#write-and-check-ihex">write_and_check_ihex</a></li>
<li class="toctree-l4"><a class="reference internal" href="#emsystem-write-hex">emsystem_write_hex</a></li>
<li class="toctree-l4"><a class="reference internal" href="#emsystem-prog">emsystem_prog</a></li>
<li class="toctree-l4"><a class="reference internal" href="#check-hex">check_hex</a></li>
<li class="toctree-l4"><a class="reference internal" href="#emsmm-read-register">emsmm_read_register</a></li>
<li class="toctree-l4"><a class="reference internal" href="#emsmm-write-register">emsmm_write_register</a></li>
<li class="toctree-l4"><a class="reference internal" href="#write-raw">write_raw</a></li>
<li class="toctree-l4"><a class="reference internal" href="#power-cycle">power_cycle</a></li>
<li class="toctree-l4"><a class="reference internal" href="#restart">restart</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-fw-headers">get_fw_headers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-rom-version">get_rom_version</a></li>
<li class="toctree-l4"><a class="reference internal" href="#erase-main">erase_main</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="authentication.html">authentication Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="ble.html">ble Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="firmware_update.html">firmware_update Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="gap.html">gap Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="gatt.html">gatt Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="hci.html">hci Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="key_container.html">key_container Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="l2cap.html">l2cap Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="nvm_info.html">nvm_info Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="sm.html">sm Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="unity.html">unity Procedures</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/blengine.html">blengine package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BLEngine</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../procedures.html">BLEngine Procedures</a></li>
      <li class="breadcrumb-item active">EMSystem Procedures</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="emsystem-procedures">
<h1>EMSystem Procedures<a class="headerlink" href="#emsystem-procedures" title="Link to this heading"></a></h1>
<input class="search input" type="text" placeholder="Live Search" style="width: 100%; padding: 10px;">
<div>&nbsp</div>
<div id="search-loader" style="display:none;">please wait...</div><section id="select-transport-dvk-device">
<span id="proc-select-transport-dvk-device"></span><h2><a class="reference internal" href="#select-transport-dvk-device">select_transport_dvk_device</a><a class="headerlink" href="#select-transport-dvk-device" title="Link to this heading"></a></h2>
<blockquote>
<div><p>Select transport DVK device</p>
<p>SPI    = 0x01
SERIAL = 0x02
I2C    = 0x03</p>
<p>DEFAULT  = 0x00
STANDARD = 0x01
FAST     = 0x02</p>
</div></blockquote>
<p><strong>API usage</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">blengine.hci.procedures.EMSystem</span> <span class="kn">import</span> <span class="n">select_transport_dvk_device</span>

<span class="n">select_transport_dvk_device</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">enable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>CLI usage</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>blengine<span class="w"> </span>run<span class="w"> </span>select_transport_dvk_device<span class="w"> </span><span class="o">[</span>-h<span class="o">]</span><span class="w"> </span><span class="nb">enable</span><span class="w"> </span>bus<span class="w"> </span>mode
</pre></div>
</div>
<p><em>Positional arguments:</em></p>
<dl class="field-list simple">
<dt class="field-odd">enable<span class="colon">:</span></dt>
<dd class="field-odd"><p>Enable or not the transport</p>
</dd>
<dt class="field-even">bus<span class="colon">:</span></dt>
<dd class="field-even"><p>Transport Bus SPI = 0x01 SERIAL = 0x02 I2C = 0x03</p>
</dd>
<dt class="field-odd">mode<span class="colon">:</span></dt>
<dd class="field-odd"><p>Transport Mode DEFAULT = 0x00 STANDARD = 0x01 FAST = 0x02</p>
</dd>
</dl>
<dl>
<dt>options:</dt><dd><dl class="option-list">
<dt><kbd><span class="option">-h</span>, <span class="option">--help</span></kbd></dt>
<dd><p>show this help message and exit</p>
</dd>
</dl>
</dd>
</dl>
<details>
<summary><a>Show Procedure Source Code</a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">select_transport_dvk_device</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">enable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Select transport DVK device</span>

<span class="sd">    SPI    = 0x01</span>
<span class="sd">    SERIAL = 0x02</span>
<span class="sd">    I2C    = 0x03</span>

<span class="sd">    DEFAULT  = 0x00</span>
<span class="sd">    STANDARD = 0x01</span>
<span class="sd">    FAST     = 0x02</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;enable:</span><span class="si">%s</span><span class="s2"> bus:</span><span class="si">%s</span><span class="s2"> mode:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

    <span class="c1">#backward compatibility</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;device_bus&quot;</span><span class="p">):</span>
        <span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span> <span class="ow">or</span> <span class="n">engine</span><span class="o">.</span><span class="n">device_bus</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;transport_mode&quot;</span><span class="p">):</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span> <span class="ow">or</span> <span class="n">engine</span><span class="o">.</span><span class="n">transport_mode</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">bus</span> <span class="o">=</span> <span class="n">TRANSPORT_BUS</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">TRANSPORT_MODE</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>
    <span class="c1">#default values</span>
    <span class="k">if</span> <span class="n">bus</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bus</span> <span class="o">=</span> <span class="n">TRANSPORT_BUS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SPI&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">TRANSPORT_MODE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DEFAULT&quot;</span><span class="p">)</span>

    <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;DVK_Select_Transport&quot;</span><span class="p">,</span><span class="n">bus</span><span class="o">=</span><span class="n">bus</span> <span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">enable</span><span class="p">:</span>
            <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;DVK_Set_SPI_Bus_Enable&quot;</span><span class="p">,</span> <span class="n">enable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;DVK_Set_SPI_Bus_Enable&quot;</span><span class="p">,</span> <span class="n">enable</span><span class="o">=</span><span class="n">enable</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;DVK transport to the device selected &quot;</span> <span class="o">+</span> <span class="n">message</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;DVK transport to the device failed, error:</span><span class="si">{}</span><span class="s2"> response:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">),</span> <span class="n">pkt</span><span class="o">.</span><span class="n">status_text</span><span class="p">)</span>
</pre></div>
</div>
</details>
<hr></section>
<section id="enter-conf-mode">
<span id="proc-enter-conf-mode"></span><h2><a class="reference internal" href="#enter-conf-mode">enter_conf_mode</a><a class="headerlink" href="#enter-conf-mode" title="Link to this heading"></a></h2>
<blockquote>
<div><p>Enter Configuration Mode</p>
</div></blockquote>
<p><strong>API usage</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">blengine.hci.procedures.EMSystem</span> <span class="kn">import</span> <span class="n">enter_conf_mode</span>

<span class="n">enter_conf_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>CLI usage</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>No<span class="w"> </span>Help
</pre></div>
</div>
<details>
<summary><a>Show Procedure Source Code</a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">enter_conf_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Enter Configuration Mode</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Enter Configuration Mode&quot;</span><span class="p">)</span>
    <span class="n">reset_ok</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_startup_event</span><span class="p">(</span><span class="n">packet</span><span class="p">):</span>
        <span class="n">reset_ok</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;STARTUP: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">packet</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">engine</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;on_ENTER_EMCORE_MODE&quot;</span><span class="p">,</span>             <span class="n">on_startup_event</span><span class="p">)</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;on_ENTER_BOOTLOADER_MODE&quot;</span><span class="p">,</span>         <span class="n">on_startup_event</span><span class="p">)</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;on_ENTER_ACTIVE_MODE&quot;</span><span class="p">,</span>           <span class="n">on_startup_event</span><span class="p">)</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;on_ENTER_CONFIGURATION_MODE&quot;</span><span class="p">,</span>    <span class="n">on_startup_event</span><span class="p">)</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;on_ENTER_PRODUCTION_TESTS_MODE&quot;</span><span class="p">,</span> <span class="n">on_startup_event</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
        <span class="n">reset_ok</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">select_transport_dvk_device</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;DVK_Target_Hard_Reset&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Target Hard Reset successfull&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">reset_ok</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">run</span><span class="p">()</span>

    <span class="n">engine</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="s2">&quot;on_ENTER_EMCORE_MODE&quot;</span><span class="p">,</span>             <span class="n">on_startup_event</span><span class="p">)</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="s2">&quot;on_ENTER_BOOTLOADER_MODE&quot;</span><span class="p">,</span>         <span class="n">on_startup_event</span><span class="p">)</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="s2">&quot;on_ENTER_ACTIVE_MODE&quot;</span><span class="p">,</span> <span class="n">on_startup_event</span><span class="p">)</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="s2">&quot;on_ENTER_CONFIGURATION_MODE&quot;</span><span class="p">,</span> <span class="n">on_startup_event</span><span class="p">)</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="s2">&quot;on_ENTER_PRODUCTION_TESTS_MODE&quot;</span><span class="p">,</span> <span class="n">on_startup_event</span><span class="p">)</span>

    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Active Mode: Successfull&quot;</span> <span class="k">if</span> <span class="n">status</span> <span class="k">else</span> <span class="s2">&quot;Active Mode: Failure&quot;</span>

    <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">message</span>
</pre></div>
</div>
</details>
<hr></section>
<section id="write-hex">
<span id="proc-write-hex"></span><h2><a class="reference internal" href="#write-hex">write_hex</a><a class="headerlink" href="#write-hex" title="Link to this heading"></a></h2>
<p>Write hex file to NVM</p>
<p><strong>API usage</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">blengine.hci.procedures.EMSystem</span> <span class="kn">import</span> <span class="n">write_hex</span>

<span class="n">write_hex</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">without_response</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>CLI usage</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>blengine<span class="w"> </span>run<span class="w"> </span>write_hex<span class="w"> </span><span class="o">[</span>-h<span class="o">]</span><span class="w"> </span><span class="o">[</span>--address<span class="w"> </span>ADDRESS<span class="o">]</span><span class="w"> </span><span class="o">[</span>--fast<span class="o">]</span><span class="w"> </span><span class="o">[</span>--progress<span class="o">]</span>
<span class="w">                  </span><span class="o">[</span>--force_empty<span class="o">]</span><span class="w"> </span><span class="o">[</span>--without_response<span class="o">]</span>
<span class="w">                  </span>file
</pre></div>
</div>
<p><em>Positional arguments:</em></p>
<dl class="field-list simple">
<dt class="field-odd">file<span class="colon">:</span></dt>
<dd class="field-odd"><p>hex file</p>
</dd>
</dl>
<dl>
<dt>options:</dt><dd><dl class="option-list">
<dt><kbd><span class="option">-h</span>, <span class="option">--help</span></kbd></dt>
<dd><p>show this help message and exit</p>
</dd>
<dt><kbd><span class="option">--address <var>ADDRESS</var></span></kbd></dt>
<dd><p>Start address</p>
</dd>
<dt><kbd><span class="option">--fast</span></kbd></dt>
<dd><p>write really fast, can induce issues</p>
</dd>
<dt><kbd><span class="option">--progress</span></kbd></dt>
<dd><p>Show Progress</p>
</dd>
<dt><kbd><span class="option">--force_empty</span></kbd></dt>
<dd><p>Force empty lines to be written</p>
</dd>
<dt><kbd><span class="option">--without_response</span></kbd></dt>
<dd><p>Use the command Write At Address Without Response</p>
</dd>
</dl>
</dd>
</dl>
<details>
<summary><a>Show Procedure Source Code</a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">write_hex</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">force_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">without_response</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">write_hex_timeout</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Write hex file to NVM&#39;&#39;&#39;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;WriteHEX&quot;</span><span class="p">)</span>

    <span class="n">write_cmd</span> <span class="o">=</span> <span class="s2">&quot;EMSMM_Write_At_Address_Without_Response&quot;</span> <span class="k">if</span> <span class="n">without_response</span> \
        <span class="k">else</span> <span class="s2">&quot;EMSMM_Write_At_Address&quot;</span>

    <span class="n">nvm_conf</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">swap_size</span><span class="p">,</span> <span class="n">empty_char</span> <span class="o">=</span> <span class="n">nvm_check_configuration</span><span class="p">(</span>
        <span class="n">engine</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Error: No file provided, quit.&quot;</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing file </span><span class="si">%s</span><span class="s2"> at 0x</span><span class="si">%08x</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span>

    <span class="c1"># Open hex file</span>
    <span class="n">hexFile</span> <span class="o">=</span> <span class="n">file</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">packet_size</span> <span class="o">=</span> <span class="n">nvm_conf</span><span class="p">[</span><span class="s2">&quot;packet_size&quot;</span><span class="p">]</span>
    <span class="n">file_line_size</span> <span class="o">=</span> <span class="n">nvm_conf</span><span class="p">[</span><span class="s2">&quot;file_line_size&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">hexFile</span><span class="p">:</span>
        <span class="n">end_of_segment</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;//&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="s1">&#39;@&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">data</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">empty_char</span><span class="o">*</span><span class="p">(</span><span class="n">file_line_size</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">total_size</span> <span class="o">+=</span> <span class="n">file_line_size</span>

    <span class="n">buff</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>

    <span class="n">total_sent</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">next_address</span> <span class="o">=</span> <span class="n">address</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">end_of_segment</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;//&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="s1">&#39;@&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">data</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># Do not write empty lines (except if explicitly required).</span>
            <span class="k">if</span> <span class="n">empty_char</span><span class="o">*</span><span class="p">(</span><span class="n">file_line_size</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">or</span> <span class="n">force_empty</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">SwapeUtils</span><span class="o">.</span><span class="n">swap</span><span class="p">(</span><span class="n">swap_size</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">file_line_size</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;Error: swape incorrect.&quot;</span>
                <span class="n">buff</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end_of_segment</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">packet_size</span> <span class="ow">or</span> <span class="n">end_of_segment</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">size_to_send</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">packet_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">buff</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">size_to_send</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">write_cmd</span><span class="p">,</span>
                                <span class="n">wait_ack</span><span class="o">=</span><span class="ow">not</span> <span class="n">fast</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">without_response</span><span class="p">,</span>
                                <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">,</span>
                                <span class="n">Start_Address</span><span class="o">=</span><span class="n">next_address</span><span class="p">,</span>
                                <span class="n">Data</span><span class="o">=</span><span class="n">buff</span><span class="p">[:</span><span class="n">size_to_send</span><span class="p">])</span>

                    <span class="n">total_sent</span> <span class="o">=</span> <span class="n">total_sent</span> <span class="o">+</span> <span class="n">size_to_send</span>
                    <span class="n">next_address</span> <span class="o">=</span> <span class="n">next_address</span> <span class="o">+</span> <span class="n">size_to_send</span>
                    <span class="n">buff</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">size_to_send</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">progress</span><span class="p">):</span>
                        <span class="n">progress</span><span class="p">(</span><span class="n">total_sent</span><span class="p">,</span> <span class="n">total_size</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">progress</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sending </span><span class="si">%d</span><span class="s2"> </span><span class="si">%%</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="n">total_sent</span> <span class="o">/</span> <span class="n">total_size</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">end_of_segment</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">next_address</span> <span class="o">=</span> <span class="n">next_address</span> <span class="o">+</span> <span class="n">file_line_size</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">write_cmd</span><span class="p">,</span>
                    <span class="n">wait_ack</span><span class="o">=</span><span class="ow">not</span> <span class="n">fast</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">without_response</span><span class="p">,</span>
                    <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">,</span>
                    <span class="n">Start_Address</span><span class="o">=</span><span class="n">next_address</span><span class="p">,</span>
                    <span class="n">Data</span><span class="o">=</span><span class="n">buff</span><span class="p">)</span>
        <span class="n">total_sent</span> <span class="o">=</span> <span class="n">total_sent</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">progress</span><span class="p">):</span>
            <span class="n">progress</span><span class="p">(</span><span class="n">total_sent</span><span class="p">,</span> <span class="n">total_size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">progress</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sended </span><span class="si">%s</span><span class="s2"> </span><span class="si">%%</span><span class="s2"> ( </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> Bytes)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">total_sent</span> <span class="o">/</span> <span class="n">total_size</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span> <span class="p">)</span>

    <span class="c1"># erase</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sended </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> Bytes&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">total_sent</span><span class="p">,</span> <span class="n">total_size</span><span class="p">))</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">hexFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Be sure all the Command Complete have been received when using fast mode.</span>
    <span class="k">if</span> <span class="n">fast</span> <span class="ow">or</span> <span class="n">without_response</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">progress</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">without_response</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;please wait...&quot;</span><span class="p">)</span>
        <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSMM_Read_At_Address&quot;</span><span class="p">,</span>
                          <span class="n">wait_ack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                          <span class="n">Start_Address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">Data_Length</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Timeout waiting for all commands to timeout&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Success    &quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Upload successful Sent </span><span class="si">{:d}</span><span class="s2"> bytes (of </span><span class="si">{:d}</span><span class="s2">) in </span><span class="si">{:3.4f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_sent</span><span class="p">,</span> <span class="n">total_size</span><span class="p">,</span> <span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>
</pre></div>
</div>
</details>
<hr></section>
<section id="write-and-check-ihex">
<span id="proc-write-and-check-ihex"></span><h2><a class="reference internal" href="#write-and-check-ihex">write_and_check_ihex</a><a class="headerlink" href="#write-and-check-ihex" title="Link to this heading"></a></h2>
<p>Write intel hex file to NVM and check CRC</p>
<p><strong>API usage</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">blengine.hci.procedures.EMSystem</span> <span class="kn">import</span> <span class="n">write_and_check_ihex</span>

<span class="n">write_and_check_ihex</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">without_response</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>CLI usage</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>blengine<span class="w"> </span>run<span class="w"> </span>write_and_check_ihex<span class="w"> </span><span class="o">[</span>-h<span class="o">]</span><span class="w"> </span><span class="o">[</span>--fast<span class="o">]</span><span class="w"> </span><span class="o">[</span>--progress<span class="o">]</span>
<span class="w">                             </span><span class="o">[</span>--without_response<span class="o">]</span>
<span class="w">                             </span>file
</pre></div>
</div>
<p><em>Positional arguments:</em></p>
<dl class="field-list simple">
<dt class="field-odd">file<span class="colon">:</span></dt>
<dd class="field-odd"><p>ihex file</p>
</dd>
</dl>
<dl>
<dt>options:</dt><dd><dl class="option-list">
<dt><kbd><span class="option">-h</span>, <span class="option">--help</span></kbd></dt>
<dd><p>show this help message and exit</p>
</dd>
<dt><kbd><span class="option">--fast</span></kbd></dt>
<dd><p>Do not wait the Command Complete Events.</p>
</dd>
<dt><kbd><span class="option">--progress</span></kbd></dt>
<dd><p>Show Progress</p>
</dd>
<dt><kbd><span class="option">--without_response</span></kbd></dt>
<dd><p>Use the command Write At Address Without Response</p>
</dd>
</dl>
</dd>
</dl>
<details>
<summary><a>Show Procedure Source Code</a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">write_and_check_ihex</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">without_response</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Write intel hex file to NVM and check CRC&#39;&#39;&#39;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;write_and_check_ihex&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Intel hex file to program: &#39;</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="n">write_cmd</span> <span class="o">=</span> <span class="s2">&quot;EMSMM_Write_At_Address_Without_Response&quot;</span> <span class="k">if</span> <span class="n">without_response</span> <span class="k">else</span> <span class="s2">&quot;EMSMM_Write_At_Address&quot;</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="n">nvm_config</span> <span class="o">=</span> <span class="n">get_nvm_configuration</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Parsing file...&quot;</span><span class="p">)</span>

    <span class="c1"># Parse the ihex file.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ihex</span> <span class="o">=</span> <span class="n">parse_ihex_file</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">e</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking CRC32...&quot;</span><span class="p">)</span>
    <span class="n">already_programmed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">ihex</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSG_Calculate_CRC32&quot;</span><span class="p">,</span>
                          <span class="n">Start_Address</span><span class="o">=</span><span class="n">addr</span><span class="p">,</span> <span class="n">End_Address</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">:</span>
            <span class="n">actual_crc</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CRC32&quot;</span><span class="p">)</span>
            <span class="n">expected_crc</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">actual_crc</span> <span class="o">!=</span> <span class="n">expected_crc</span><span class="p">:</span>
                <span class="n">already_programmed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CRC Calculation error : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pkt</span><span class="p">)</span>
            <span class="n">already_programmed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">already_programmed</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;File Already Programmed&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">msg</span>

    <span class="c1"># Check if the ihex is already programmed on the device.</span>
    <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking emcore compliance...&quot;</span><span class="p">)</span>
        <span class="n">file_header_ok</span><span class="p">,</span> <span class="n">file_headers</span> <span class="o">=</span> <span class="n">get_fw_headers</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">ihex</span><span class="o">=</span><span class="n">ihex</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">device_header_ok</span><span class="p">,</span> <span class="n">device_headers</span> <span class="o">=</span> <span class="n">get_fw_headers</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">compliant</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">file_header_ok</span> <span class="ow">and</span> <span class="n">device_header_ok</span><span class="p">:</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">file_headers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;section_code&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x03</span> <span class="ow">and</span> <span class="n">fh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_flavor&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">fh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_stack&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dh</span> <span class="ow">in</span> <span class="n">device_headers</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;section_code&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">dh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_flavor&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_flavor&quot;</span><span class="p">):</span>
                            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Wrong EMCore flavor, ihex ask for </span><span class="si">%s</span><span class="s2">, device have </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_flavor&quot;</span><span class="p">),</span> <span class="n">dh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_flavor&quot;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">dh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_stack&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_stack&quot;</span><span class="p">):</span>
                            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Wrong EMCore Stack, ihex ask for </span><span class="si">%s</span><span class="s2">, device have </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_stack&quot;</span><span class="p">),</span> <span class="n">dh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_stack&quot;</span><span class="p">))</span>
                        <span class="n">compliant</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">compliant</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">device_headers</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;IHEX need EmCore flavor </span><span class="si">%s</span><span class="s2"> stack </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_flavor&quot;</span><span class="p">),</span> <span class="n">dh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_stack&quot;</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping emcore compliance check.&quot;</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Erasing pages...&quot;</span><span class="p">)</span>
    <span class="c1"># erase pages and compute total size</span>
    <span class="k">for</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">ihex</span><span class="p">:</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">mem_infos</span> <span class="o">=</span> <span class="n">get_memory_infos_from_address</span><span class="p">(</span><span class="n">nvm_config</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">mem_infos</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Check which NVM pages have to be erased.</span>
            <span class="n">start_page</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">-</span> <span class="n">mem_infos</span><span class="p">[</span><span class="s2">&quot;base_addr&quot;</span><span class="p">])</span> <span class="o">//</span> <span class="mh">0x2000</span>
            <span class="n">end_page</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr</span> <span class="o">-</span> <span class="n">mem_infos</span><span class="p">[</span><span class="s2">&quot;base_addr&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mh">0x2000</span>
            <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_page</span><span class="p">,</span> <span class="n">end_page</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSMM_NVM_Erase_Page&quot;</span><span class="p">,</span> <span class="n">Area</span><span class="o">=</span><span class="n">mem_infos</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">],</span> <span class="n">Page</span><span class="o">=</span><span class="n">page</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Error while erasing page </span><span class="si">%s</span><span class="s2"> (0x</span><span class="si">%x</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pkt</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">msg</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;0x</span><span class="si">{:08x}</span><span class="s2">: </span><span class="si">{:d}</span><span class="s2"> bytes&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>


    <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Correcting data length for device memory compliance...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">ihex</span><span class="p">:</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">mem_infos</span> <span class="o">=</span> <span class="n">get_memory_infos_from_address</span><span class="p">(</span><span class="n">nvm_config</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">%</span> <span class="n">mem_infos</span><span class="p">[</span><span class="s2">&quot;swap_size&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">mem_infos</span><span class="p">[</span><span class="s2">&quot;swap_size&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">%</span> <span class="n">mem_infos</span><span class="p">[</span><span class="s2">&quot;swap_size&quot;</span><span class="p">])</span>
                <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mh">0xFF</span><span class="p">]</span> <span class="o">*</span> <span class="n">size</span><span class="p">)</span>

            <span class="n">total_size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;data size for area </span><span class="si">{</span><span class="n">mem_infos</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> is </span><span class="si">{</span><span class="n">mem_infos</span><span class="p">[</span><span class="s2">&quot;swap_size&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> bytes&#39;</span><span class="p">)</span>

    <span class="c1"># Write data.</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing data...&quot;</span><span class="p">)</span>
    <span class="n">packet_size</span> <span class="o">=</span> <span class="n">nvm_config</span><span class="p">[</span><span class="s2">&quot;packet_size&quot;</span><span class="p">]</span>
    <span class="n">total_sent</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">ihex</span><span class="p">:</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">size_to_send</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">packet_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

            <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">write_cmd</span><span class="p">,</span>
                              <span class="n">wait_ack</span><span class="o">=</span><span class="ow">not</span> <span class="n">fast</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">without_response</span><span class="p">,</span>
                              <span class="n">Start_Address</span><span class="o">=</span><span class="n">addr</span><span class="p">,</span>
                              <span class="n">Data</span><span class="o">=</span><span class="n">data</span><span class="p">[:</span><span class="n">size_to_send</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">fast</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">without_response</span> <span class="ow">and</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Communication error.&quot;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">msg</span>

            <span class="n">addr</span> <span class="o">+=</span> <span class="n">size_to_send</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">size_to_send</span><span class="p">:]</span>
            <span class="n">total_sent</span> <span class="o">+=</span> <span class="n">size_to_send</span>

            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">progress</span><span class="p">):</span>
                <span class="n">progress</span><span class="p">(</span><span class="n">total_sent</span><span class="p">,</span> <span class="n">total_size</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">progress</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sending </span><span class="si">%d</span><span class="s2"> </span><span class="si">%%</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="n">total_sent</span> <span class="o">/</span> <span class="n">total_size</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Be sure all the Command Complete have been received when using fast mode.</span>
    <span class="k">if</span> <span class="n">fast</span> <span class="ow">or</span> <span class="n">without_response</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">progress</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">without_response</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting all Command Complete...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSMM_Read_At_Address&quot;</span><span class="p">,</span>
                          <span class="n">wait_ack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                          <span class="n">Start_Address</span><span class="o">=</span><span class="n">ihex</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">Data_Length</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Communication error.&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">msg</span>

    <span class="c1"># Check data.</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking data...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">ihex</span><span class="p">:</span>
        <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSG_Calculate_CRC32&quot;</span><span class="p">,</span>
                          <span class="n">Start_Address</span><span class="o">=</span><span class="n">addr</span><span class="p">,</span> <span class="n">End_Address</span><span class="o">=</span><span class="n">addr</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">pkt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Failed to calculate CRC32&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">msg</span>
        <span class="n">actual_crc</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CRC32&quot;</span><span class="p">)</span>
        <span class="n">expected_crc</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">actual_crc</span> <span class="o">!=</span> <span class="n">expected_crc</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid CRC32 from 0x</span><span class="si">{:08x}</span><span class="s2"> to 0x</span><span class="si">{:08x}</span><span class="s2"> (0x</span><span class="si">{:08x}</span><span class="s2"> instead of 0x</span><span class="si">{:08x}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">addr</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">actual_crc</span><span class="p">,</span> <span class="n">expected_crc</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">msg</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Successfully written </span><span class="si">{:d}</span><span class="s2"> bytes (of </span><span class="si">{:d}</span><span class="s2">) in </span><span class="si">{:.3f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">total_sent</span><span class="p">,</span> <span class="n">total_size</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">msg</span>
</pre></div>
</div>
</details>
<hr></section>
<section id="emsystem-write-hex">
<span id="proc-emsystem-write-hex"></span><h2><a class="reference internal" href="#emsystem-write-hex">emsystem_write_hex</a><a class="headerlink" href="#emsystem-write-hex" title="Link to this heading"></a></h2>
<p>emsystem Write hex file to NVM</p>
<p><strong>API usage</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">blengine.hci.procedures.EMSystem</span> <span class="kn">import</span> <span class="n">emsystem_write_hex</span>

<span class="n">emsystem_write_hex</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spi_disable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_address</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">without_response</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>CLI usage</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>blengine<span class="w"> </span>run<span class="w"> </span>emsystem_write_hex<span class="w"> </span><span class="o">[</span>-h<span class="o">]</span><span class="w"> </span><span class="o">[</span>--files<span class="w"> </span>FILES<span class="w"> </span><span class="o">[</span>FILES<span class="w"> </span>...<span class="o">]]</span>
<span class="w">                           </span><span class="o">[</span>--directory<span class="w"> </span>DIRECTORY<span class="o">]</span><span class="w"> </span><span class="o">[</span>--address<span class="w"> </span>ADDRESS<span class="o">]</span>
<span class="w">                           </span><span class="o">[</span>--spi_disable<span class="o">]</span><span class="w"> </span><span class="o">[</span>--return_address<span class="o">]</span>
</pre></div>
</div>
<dl>
<dt>options:</dt><dd><dl class="option-list">
<dt><kbd><span class="option">-h</span>, <span class="option">--help</span></kbd></dt>
<dd><p>show this help message and exit</p>
</dd>
</dl>
<dl class="simple">
<dt>–files FILES [FILES …]</dt><dd><p>hex file(s)</p>
</dd>
</dl>
<dl class="option-list">
<dt><kbd><span class="option">--directory <var>DIRECTORY</var></span></kbd></dt>
<dd><p>The directory where the files are located</p>
</dd>
<dt><kbd><span class="option">--address <var>ADDRESS</var></span></kbd></dt>
<dd><p>Memory Address 0xXX..</p>
</dd>
<dt><kbd><span class="option">--spi_disable</span></kbd></dt>
<dd><p>Disable SPI configure mode</p>
</dd>
<dt><kbd><span class="option">--return_address</span></kbd></dt>
<dd><p>Read the bluetooth address of the device before
programming. The value is stored in the engine
parameter local_address</p>
</dd>
</dl>
</dd>
</dl>
<details>
<summary><a>Show Procedure Source Code</a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">emsystem_write_hex</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spi_disable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">return_address</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">write_hex_timeout</span><span class="p">,</span>
                       <span class="n">fast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">without_response</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;emsystem Write hex file to NVM&#39;&#39;&#39;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;emsystem_write_hex&quot;</span><span class="p">)</span>

    <span class="n">reset_ok</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

    <span class="n">files_ext</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">files_ext</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">files_ext</span> <span class="o">=</span> <span class="n">ext</span>
        <span class="k">elif</span> <span class="n">files_ext</span> <span class="o">!=</span> <span class="n">ext</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;All files must have the same extension&quot;</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Files type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">files_ext</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">run</span><span class="p">():</span>

        <span class="n">engine</span><span class="o">.</span><span class="n">device_mode_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="n">select_transport_dvk_device</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_address</span><span class="p">:</span>
            <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSG_Read_MAC_Address&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read BD ADDR successfull&quot;</span><span class="p">)</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">local_address</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MAC&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No BD ADDR&quot;</span><span class="p">)</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">local_address</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Failed to read the mac address, is infopage 3 populated ? response </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pkt</span><span class="o">.</span><span class="n">status_text</span>

        <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;DVK_Target_Hard_Reset&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">engine</span><span class="o">.</span><span class="n">device_mode_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Hard Reset timeout, startup packet missed ?&quot;</span>

        <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Target Hard Reset successfull&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Cannot hard reset the device </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pkt</span><span class="o">.</span><span class="n">status_text</span>
        <span class="k">if</span> <span class="n">files_ext</span> <span class="o">!=</span> <span class="s2">&quot;ihex&quot;</span><span class="p">:</span>
            <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSMM_NVM_Erase_Main&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;NVM Erase Main successfull&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Cannot erase Main NVM Area&quot;</span>

        <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">status_message</span> <span class="o">=</span> <span class="s2">&quot;Programming firmware started&quot;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">directory</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span> <span class="o">/</span> <span class="n">f</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Programming firmware </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">files_ext</span> <span class="o">!=</span> <span class="s2">&quot;ihex&quot;</span><span class="p">:</span>
                    <span class="n">status</span><span class="p">,</span> <span class="n">status_message</span> <span class="o">=</span> <span class="n">write_hex</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">fo</span><span class="p">,</span>
                                                    <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
                                                    <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                                                    <span class="n">fast</span><span class="o">=</span><span class="n">fast</span><span class="p">,</span>
                                                    <span class="n">without_response</span><span class="o">=</span><span class="n">without_response</span><span class="p">,</span>
                                                    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                                                    <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">)</span>

                    <span class="n">check_status</span><span class="p">,</span> <span class="n">check_msg</span> <span class="o">=</span> <span class="n">check_hex</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">check_status</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">check_status</span><span class="p">,</span> <span class="s2">&quot;check_hex error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">check_msg</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">status</span><span class="p">,</span> <span class="n">status_message</span> <span class="o">=</span> <span class="n">write_and_check_ihex</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">fo</span><span class="p">,</span>
                                                <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                                                <span class="n">fast</span><span class="o">=</span><span class="n">fast</span><span class="p">,</span>
                                                <span class="n">without_response</span><span class="o">=</span><span class="n">without_response</span><span class="p">,</span>
                                                <span class="n">check</span><span class="o">=</span><span class="n">check</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Write Failure: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">status_message</span>

        <span class="n">engine</span><span class="o">.</span><span class="n">device_mode_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;DVK_Target_Hard_Reset&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">engine</span><span class="o">.</span><span class="n">device_mode_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;Hard Reset Timeout, startup packet missed.</span>
<span class="s1">                        But It is possible that the application does not send the event.&#39;&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Target Hard Reset successfull&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Cannot hard reset the device </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pkt</span><span class="o">.</span><span class="n">status_text</span>

        <span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">device_mode</span> <span class="o">==</span> <span class="s2">&quot;emshi&quot;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Device in EMSHI mode&quot;</span><span class="p">)</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">detect_fw_stack</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">spi_disable</span><span class="p">:</span>
            <span class="n">select_transport_dvk_device</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">status_message</span>

    <span class="n">status</span><span class="p">,</span> <span class="n">status_message</span> <span class="o">=</span> <span class="n">run</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">status_message</span>
</pre></div>
</div>
</details>
<hr></section>
<section id="emsystem-prog">
<span id="proc-emsystem-prog"></span><h2><a class="reference internal" href="#emsystem-prog">emsystem_prog</a><a class="headerlink" href="#emsystem-prog" title="Link to this heading"></a></h2>
<p>prog file(s) to the device</p>
<p><strong>API usage</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">blengine.hci.procedures.EMSystem</span> <span class="kn">import</span> <span class="n">emsystem_prog</span>

<span class="n">emsystem_prog</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">version_check</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spi_disable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_address</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">without_response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>CLI usage</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>blengine<span class="w"> </span>run<span class="w"> </span>emsystem_prog<span class="w"> </span><span class="o">[</span>-h<span class="o">]</span><span class="w"> </span><span class="o">[</span>--directory<span class="w"> </span>DIRECTORY<span class="o">]</span><span class="w"> </span><span class="o">[</span>--address<span class="w"> </span>ADDRESS<span class="o">]</span>
<span class="w">                      </span><span class="o">[</span>--version_check<span class="w"> </span>VERSION_CHECK<span class="o">]</span><span class="w"> </span><span class="o">[</span>--spi_disable<span class="o">]</span>
<span class="w">                      </span><span class="o">[</span>--return_address<span class="o">]</span><span class="w"> </span><span class="o">[</span>--progress<span class="o">]</span><span class="w"> </span><span class="o">[</span>--slow<span class="o">]</span>
<span class="w">                      </span><span class="o">[</span>--check-emcore<span class="o">]</span>
<span class="w">                      </span>files<span class="w"> </span><span class="o">[</span>files<span class="w"> </span>...<span class="o">]</span>
</pre></div>
</div>
<p><em>Positional arguments:</em></p>
<dl class="field-list simple">
<dt class="field-odd">files<span class="colon">:</span></dt>
<dd class="field-odd"><p>hex file(s)</p>
</dd>
</dl>
<dl>
<dt>options:</dt><dd><dl class="option-list">
<dt><kbd><span class="option">-h</span>, <span class="option">--help</span></kbd></dt>
<dd><p>show this help message and exit</p>
</dd>
<dt><kbd><span class="option">--directory <var>DIRECTORY</var></span></kbd></dt>
<dd><p>The directory where the files are located</p>
</dd>
<dt><kbd><span class="option">--address <var>ADDRESS</var></span></kbd></dt>
<dd><p>Memory Address 0xXX..</p>
</dd>
<dt><kbd><span class="option">--version_check <var>VERSION_CHECK</var></span></kbd></dt>
<dd><p>9304 ONLY. Check that the indicated version is the
same as the current version of the device. If it is
the same version, it is not programmed again. If the
device does not have a version or the version is
different, the device is programmed with the version
indicated</p>
</dd>
<dt><kbd><span class="option">--spi_disable</span></kbd></dt>
<dd><p>Disable SPI configure mode</p>
</dd>
<dt><kbd><span class="option">--return_address</span></kbd></dt>
<dd><p>Read the bluetooth address of the device before
programming. The value is stored in the engine
parameter local_address</p>
</dd>
<dt><kbd><span class="option">--progress</span></kbd></dt>
<dd><p>Show Progress</p>
</dd>
<dt><kbd><span class="option">--slow</span></kbd></dt>
<dd><p>Slow but secure programming (ack every packets)</p>
</dd>
<dt><kbd><span class="option">--check-emcore</span></kbd></dt>
<dd><p>Enable EMCore compliance check. ihex only.</p>
</dd>
</dl>
</dd>
</dl>
<details>
<summary><a>Show Procedure Source Code</a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">emsystem_prog</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">version_check</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">spi_disable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_address</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">write_hex_timeout</span><span class="p">,</span>
                  <span class="n">fast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">without_response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;prog file(s) to the device&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">device_model</span> <span class="o">==</span> <span class="n">Ic_Id_t</span><span class="o">.</span><span class="n">EM9304</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
        <span class="n">wp</span> <span class="o">=</span> <span class="n">EM9304_Write_Patch</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span>
                                <span class="n">directory</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span>
                                <span class="n">destination_memory</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
                                <span class="n">version</span><span class="o">=</span><span class="n">version_check</span><span class="p">,</span>
                                <span class="n">spi_disable</span><span class="o">=</span><span class="n">spi_disable</span><span class="p">,</span>
                                <span class="n">read_address</span><span class="o">=</span><span class="n">return_address</span>
                                <span class="p">)</span>
        <span class="n">status_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">status_wp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">message_status</span> <span class="o">=</span> <span class="s2">&quot;Write Patch Success&quot;</span> <span class="k">if</span> <span class="n">status</span> <span class="k">else</span> <span class="s2">&quot;Error in Write Patch: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">status_wp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">message_status</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">emsystem_write_hex</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span>
                                  <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span>
                                  <span class="n">directory</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span>
                                  <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
                                  <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                                  <span class="n">spi_disable</span><span class="o">=</span><span class="n">spi_disable</span><span class="p">,</span>
                                  <span class="n">return_address</span><span class="o">=</span><span class="n">return_address</span><span class="p">,</span>
                                  <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                                  <span class="n">fast</span><span class="o">=</span><span class="n">fast</span><span class="p">,</span>
                                  <span class="n">without_response</span><span class="o">=</span><span class="n">without_response</span><span class="p">,</span>
                                  <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">,</span>
                                  <span class="n">check</span><span class="o">=</span><span class="n">check</span>
                                  <span class="p">)</span>
</pre></div>
</div>
</details>
<hr></section>
<section id="check-hex">
<span id="proc-check-hex"></span><h2><a class="reference internal" href="#check-hex">check_hex</a><a class="headerlink" href="#check-hex" title="Link to this heading"></a></h2>
<p>Check hex file to NVM/IRAM</p>
<p><strong>API usage</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">blengine.hci.procedures.EMSystem</span> <span class="kn">import</span> <span class="n">check_hex</span>

<span class="n">check_hex</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>CLI usage</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>No<span class="w"> </span>Help
</pre></div>
</div>
<details>
<summary><a>Show Procedure Source Code</a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">check_hex</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Check hex file to NVM/IRAM&#39;&#39;&#39;</span>

    <span class="n">nvm_conf</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">swap_size</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nvm_check_configuration</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Error: No file provided, quit.&quot;</span>

    <span class="c1"># Open hex file</span>
    <span class="n">hexFile</span> <span class="o">=</span> <span class="n">file</span>

    <span class="n">file_line_size</span> <span class="o">=</span> <span class="mi">32</span>

    <span class="n">buff</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">hexFile</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;//&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="s1">&#39;@&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">data</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">SwapeUtils</span><span class="o">.</span><span class="n">swap</span><span class="p">(</span><span class="n">swap_size</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">file_line_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Swap error for paremeters </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">swap_size</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">file_line_size</span><span class="p">)</span>
            <span class="n">buff</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">hexFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSG_Calculate_CRC32&quot;</span><span class="p">,</span>
                      <span class="n">Start_Address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">End_Address</span><span class="o">=</span><span class="n">address</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">buff</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">pkt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Device Failed to calculate CRC32, response </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pkt</span><span class="o">.</span><span class="n">status_text</span>

    <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CRC32&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="n">buff</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;CRC32 mismatch (0x</span><span class="si">%08x</span><span class="s2"> instead of 0x</span><span class="si">%08x</span><span class="s2">), quit.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CRC32&quot;</span><span class="p">),</span> <span class="n">binascii</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="n">buff</span><span class="p">))</span>

    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;OK: CRC32 match (0x</span><span class="si">%08x</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CRC32&quot;</span><span class="p">))</span>
</pre></div>
</div>
</details>
<hr></section>
<section id="emsmm-read-register">
<span id="proc-emsmm-read-register"></span><h2><a class="reference internal" href="#emsmm-read-register">emsmm_read_register</a><a class="headerlink" href="#emsmm-read-register" title="Link to this heading"></a></h2>
<blockquote>
<div><p>EMSystem Read Register Procedure</p>
</div></blockquote>
<p><strong>API usage</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">blengine.hci.procedures.EMSystem</span> <span class="kn">import</span> <span class="n">emsmm_read_register</span>

<span class="n">emsmm_read_register</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>CLI usage</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>blengine<span class="w"> </span>run<span class="w"> </span>emsmm_read_register<span class="w"> </span><span class="o">[</span>-h<span class="o">]</span><span class="w"> </span><span class="o">[</span>--length<span class="w"> </span>LENGTH<span class="o">]</span><span class="w"> </span>address
</pre></div>
</div>
<p><em>Positional arguments:</em></p>
<dl class="field-list simple">
<dt class="field-odd">address<span class="colon">:</span></dt>
<dd class="field-odd"><p>address (hex format: 0x12345678)</p>
</dd>
</dl>
<dl>
<dt>options:</dt><dd><dl class="option-list">
<dt><kbd><span class="option">-h</span>, <span class="option">--help</span></kbd></dt>
<dd><p>show this help message and exit</p>
</dd>
<dt><kbd><span class="option">--length <var>LENGTH</var></span></kbd></dt>
<dd><p>length to read</p>
</dd>
</dl>
</dd>
</dl>
<details>
<summary><a>Show Procedure Source Code</a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">emsmm_read_register</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    EMSystem Read Register Procedure</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">parse_str_input_value</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

    <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSMM_Read_At_Address&quot;</span><span class="p">,</span>
                      <span class="n">Start_Address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">Data_Length</span><span class="o">=</span><span class="n">length</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Failed to read register@</span><span class="si">%x</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">pkt</span><span class="o">.</span><span class="n">status_text</span><span class="p">)</span>

    <span class="k">return</span> <span class="s2">&quot;0x&quot;</span> <span class="o">+</span> <span class="nb">format</span><span class="p">(</span><span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">hex</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;big&quot;</span><span class="p">))</span>
</pre></div>
</div>
</details>
<hr></section>
<section id="emsmm-write-register">
<span id="proc-emsmm-write-register"></span><h2><a class="reference internal" href="#emsmm-write-register">emsmm_write_register</a><a class="headerlink" href="#emsmm-write-register" title="Link to this heading"></a></h2>
<blockquote>
<div><p>EMSMM Write Register Procedure</p>
</div></blockquote>
<p><strong>API usage</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">blengine.hci.procedures.EMSystem</span> <span class="kn">import</span> <span class="n">emsmm_write_register</span>

<span class="n">emsmm_write_register</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s1">&#39;0xF0000000&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;0x00000000&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>CLI usage</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>blengine<span class="w"> </span>run<span class="w"> </span>emsmm_write_register<span class="w"> </span><span class="o">[</span>-h<span class="o">]</span><span class="w"> </span>address<span class="w"> </span>value
</pre></div>
</div>
<p><em>Positional arguments:</em></p>
<dl class="field-list simple">
<dt class="field-odd">address<span class="colon">:</span></dt>
<dd class="field-odd"><p>address (hex format: 0x12345678)</p>
</dd>
<dt class="field-even">value<span class="colon">:</span></dt>
<dd class="field-even"><p>value (hex format: 0x12345678)</p>
</dd>
</dl>
<dl>
<dt>options:</dt><dd><dl class="option-list">
<dt><kbd><span class="option">-h</span>, <span class="option">--help</span></kbd></dt>
<dd><p>show this help message and exit</p>
</dd>
</dl>
</dd>
</dl>
<details>
<summary><a>Show Procedure Source Code</a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">emsmm_write_register</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;0xF0000000&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;0x00000000&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    EMSMM Write Register Procedure</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">parse_str_input_value</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">parse_str_input_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c1">#print(&quot;Writing %s at %s&quot; % (hex(value), hex(address)))</span>
    <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSMM_Write_At_Address&quot;</span><span class="p">,</span>
                      <span class="n">Start_Address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">Data</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Failed to write register@</span><span class="si">%x</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">pkt</span><span class="o">.</span><span class="n">status_text</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">pkt</span><span class="o">.</span><span class="n">status_text</span>
</pre></div>
</div>
</details>
<hr></section>
<section id="write-raw">
<span id="proc-write-raw"></span><h2><a class="reference internal" href="#write-raw">write_raw</a><a class="headerlink" href="#write-raw" title="Link to this heading"></a></h2>
<blockquote>
<div><p>Write raw data from binary file to NVM/IRAM</p>
</div></blockquote>
<p><strong>API usage</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">blengine.hci.procedures.EMSystem</span> <span class="kn">import</span> <span class="n">write_raw</span>

<span class="n">write_raw</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s1">&#39;0x320000&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>CLI usage</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>blengine<span class="w"> </span>run<span class="w"> </span>write_raw<span class="w"> </span><span class="o">[</span>-h<span class="o">]</span><span class="w"> </span><span class="o">[</span>--address<span class="w"> </span>ADDRESS<span class="o">]</span><span class="w"> </span><span class="o">[</span>--fast<span class="o">]</span><span class="w"> </span><span class="o">[</span>--progress<span class="o">]</span><span class="w"> </span>file
</pre></div>
</div>
<p><em>Positional arguments:</em></p>
<dl class="field-list simple">
<dt class="field-odd">file<span class="colon">:</span></dt>
<dd class="field-odd"><p>raw file</p>
</dd>
</dl>
<dl>
<dt>options:</dt><dd><dl class="option-list">
<dt><kbd><span class="option">-h</span>, <span class="option">--help</span></kbd></dt>
<dd><p>show this help message and exit</p>
</dd>
<dt><kbd><span class="option">--address <var>ADDRESS</var></span></kbd></dt>
<dd><p>Start address</p>
</dd>
<dt><kbd><span class="option">--fast</span></kbd></dt>
<dd><p>write really fast, can induce issues</p>
</dd>
<dt><kbd><span class="option">--progress</span></kbd></dt>
<dd><p>Show Progress</p>
</dd>
</dl>
</dd>
</dl>
<details>
<summary><a>Show Procedure Source Code</a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">write_raw</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s1">&#39;0x320000&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Write raw data from binary file to NVM/IRAM</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Write RAW&quot;</span><span class="p">)</span>

    <span class="n">status</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nvm_check_configuration</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Error: Address out of range, quit.&quot;</span>

    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Error: No file provided, quit.&quot;</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing file </span><span class="si">%s</span><span class="s2"> at </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span>

    <span class="c1"># Open hex file</span>
    <span class="n">rawFile</span> <span class="o">=</span> <span class="n">file</span>

    <span class="n">next_address</span> <span class="o">=</span> <span class="n">address</span>
    <span class="n">total_sent</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">packet_size</span> <span class="o">=</span> <span class="mi">248</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="n">buff</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">rawFile</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">size_to_send</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">packet_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">buff</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">size_to_send</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSMM_Write_At_Address&quot;</span><span class="p">,</span>
                              <span class="n">wait_ack</span><span class="o">=</span><span class="ow">not</span> <span class="n">fast</span><span class="p">,</span>
                              <span class="n">Start_Address</span><span class="o">=</span><span class="n">next_address</span><span class="p">,</span>
                              <span class="n">Data</span><span class="o">=</span><span class="n">buff</span><span class="p">[:</span><span class="n">size_to_send</span><span class="p">]</span>
                              <span class="p">)</span>

            <span class="n">total_sent</span> <span class="o">=</span> <span class="n">total_sent</span> <span class="o">+</span> <span class="n">size_to_send</span>

            <span class="n">buff</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">size_to_send</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">progress</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sent: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">total_sent</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">next_address</span> <span class="o">=</span> <span class="n">next_address</span> <span class="o">+</span> <span class="n">size_to_send</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">rawFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Successfully uploaded, Sent </span><span class="si">{:d}</span><span class="s2"> bytes in </span><span class="si">{:3.4f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_sent</span><span class="p">,</span> <span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>
</pre></div>
</div>
</details>
<hr></section>
<section id="power-cycle">
<span id="proc-power-cycle"></span><h2><a class="reference internal" href="#power-cycle">power_cycle</a><a class="headerlink" href="#power-cycle" title="Link to this heading"></a></h2>
<blockquote>
<div><p>This procedure requires a DVK as the DVK_Target_Hard_Reset is
processed by the main CPU of the DVK.</p>
</div></blockquote>
<p><strong>API usage</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">blengine.hci.procedures.EMSystem</span> <span class="kn">import</span> <span class="n">power_cycle</span>

<span class="n">power_cycle</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>CLI usage</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>blengine<span class="w"> </span>run<span class="w"> </span>power_cycle<span class="w"> </span><span class="o">[</span>-h<span class="o">]</span><span class="w"> </span><span class="o">[</span>-m<span class="w"> </span><span class="o">{</span>default,config<span class="o">}]</span>
</pre></div>
</div>
<dl>
<dt>options:</dt><dd><dl class="option-list">
<dt><kbd><span class="option">-h</span>, <span class="option">--help</span></kbd></dt>
<dd><p>show this help message and exit</p>
</dd>
</dl>
<dl class="simple">
<dt>-m {default,config}, –mode {default,config}</dt><dd><p>Power cycle mode</p>
</dd>
</dl>
</dd>
</dl>
<details>
<summary><a>Show Procedure Source Code</a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">power_cycle</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This procedure requires a DVK as the DVK_Target_Hard_Reset is</span>
<span class="sd">    processed by the main CPU of the DVK.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">em</span> <span class="o">=</span> <span class="n">auth</span> <span class="o">==</span> <span class="s2">&quot;em&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span>

    <span class="n">engine</span><span class="o">.</span><span class="n">device_mode_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="n">select_transport_dvk_device</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Power Cycle&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Power cycling in </span><span class="si">%s</span><span class="s2"> mode...&quot;</span> <span class="o">%</span> <span class="n">mode</span><span class="p">)</span>

    <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;DVK_Target_Hard_Reset&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">POWERCYCLE_MODES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">device_mode_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">device_mode</span> <span class="o">==</span> <span class="n">mode</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Successfully power cycle in </span><span class="si">%s</span><span class="s2"> mode&quot;</span> <span class="o">%</span> <span class="n">engine</span><span class="o">.</span><span class="n">device_mode</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Fail, power cycle in </span><span class="si">%s</span><span class="s2"> instead of </span><span class="si">%s</span><span class="s2"> mode!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">device_mode</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Restarted in </span><span class="si">%s</span><span class="s2"> mode&quot;</span> <span class="o">%</span> <span class="n">engine</span><span class="o">.</span><span class="n">device_mode</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;No startup event received&quot;</span>
</pre></div>
</div>
</details>
<hr></section>
<section id="restart">
<span id="proc-restart"></span><h2><a class="reference internal" href="#restart">restart</a><a class="headerlink" href="#restart" title="Link to this heading"></a></h2>
<blockquote>
<div><p>Restart the system in a given mode
Supported Modes: EMCore, Application, Bootloader or Configuration Mode.</p>
<p>Authentication procedure is available as an option.</p>
</div></blockquote>
<p><strong>API usage</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">blengine.hci.procedures.EMSystem</span> <span class="kn">import</span> <span class="n">restart</span>

<span class="n">restart</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>CLI usage</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>blengine<span class="w"> </span>run<span class="w"> </span>restart<span class="w"> </span><span class="o">[</span>-h<span class="o">]</span><span class="w"> </span><span class="o">[</span>-m<span class="w"> </span><span class="o">{</span>default,emcore,bootloader,active,config<span class="o">}]</span>
<span class="w">                </span><span class="o">[</span>-a<span class="w"> </span>AUTH<span class="o">]</span>
</pre></div>
</div>
<dl>
<dt>options:</dt><dd><dl class="option-list">
<dt><kbd><span class="option">-h</span>, <span class="option">--help</span></kbd></dt>
<dd><p>show this help message and exit</p>
</dd>
</dl>
<dl class="simple">
<dt>-m {default,emcore,bootloader,active,config}, –mode {default,emcore,bootloader,active,config}</dt><dd><p>Mode to execute</p>
</dd>
</dl>
<dl class="option-list">
<dt><kbd><span class="option">-a <var>AUTH</var></span>, <span class="option">--auth <var>AUTH</var></span></kbd></dt>
<dd><p>Authentication level: eigher “user” or “em”</p>
</dd>
</dl>
</dd>
</dl>
<details>
<summary><a>Show Procedure Source Code</a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Restart the system in a given mode</span>
<span class="sd">    Supported Modes: EMCore, Application, Bootloader or Configuration Mode.</span>

<span class="sd">    Authentication procedure is available as an option.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">em</span> <span class="o">=</span> <span class="n">auth</span> <span class="o">==</span> <span class="s2">&quot;em&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restart&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restarting in </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2"> mode...&quot;</span><span class="p">)</span>

    <span class="n">mode_register_address</span> <span class="o">=</span> <span class="mh">0x00F00430</span>

    <span class="n">mode_register_mask</span> <span class="o">=</span> <span class="mh">0xFF7CFFFF</span>

    <span class="c1"># should it test for current device_mode ??</span>

    <span class="n">engine</span><span class="o">.</span><span class="n">device_mode_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;config&quot;</span><span class="p">:</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSG_Enter_Configuration_Mode&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
        <span class="n">packet</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSG_Leave_Configuration_Mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">packet</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">:</span>
            <span class="c1"># This means we were not in CM, so we have to clear</span>
            <span class="c1"># PML register and restart.</span>
            <span class="n">packet</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSG_Clear_Mode_Flags&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># The EMSG_Set_Boot_Mode_Flags performs a CPU Reset</span>
        <span class="c1"># after PML Register configuration.</span>
        <span class="c1"># There is no need to issue the EMSG_CPU_Reset command.</span>
        <span class="n">packet</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSG_Set_Boot_Mode_Flags&quot;</span><span class="p">,</span> <span class="n">Boot_Mode</span><span class="o">=</span><span class="n">RESTART_MODES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">packet</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">:</span>
            <span class="c1"># Unknown HCI Command -&gt; We are running from a firmware that does not support this command.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restart&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running firmware does not support EMSG_Set_Boot_Mode_Flags, restart in Configuration Mode and update registers.&quot;</span><span class="p">)</span>

            <span class="n">packet</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;DVK_Target_Hard_Reset&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">packet</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Failed to execute DVK_Target_Hard_Reset: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">packet</span><span class="o">.</span><span class="n">status_text</span>

            <span class="n">packet</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSMM_Read_At_Address&quot;</span><span class="p">,</span>
                <span class="n">Start_Address</span><span class="o">=</span><span class="n">mode_register_address</span><span class="p">,</span> <span class="n">Data_Length</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">packet</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Insufficient Authentication</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Read register error@</span><span class="si">%x</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mode_register_address</span><span class="p">,</span> <span class="n">packet</span><span class="o">.</span><span class="n">status_text</span><span class="p">)</span>

            <span class="n">register_value</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">),</span> <span class="s2">&quot;little&quot;</span><span class="p">)</span>
            <span class="c1"># clear application mode flags and configuration mode flag</span>
            <span class="n">register_value</span> <span class="o">&amp;=</span> <span class="n">mode_register_mask</span>

            <span class="n">register_value</span> <span class="o">|=</span> <span class="n">RESTART_MODES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restart&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Write </span><span class="si">%s</span><span class="s2"> @ </span><span class="si">%x</span><span class="s2">&quot;</span><span class="o">%</span> <span class="p">(</span> <span class="nb">hex</span><span class="p">(</span><span class="n">register_value</span><span class="p">),</span> <span class="n">mode_register_address</span><span class="p">))</span>

            <span class="n">packet</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSMM_Write_At_Address&quot;</span><span class="p">,</span>
                <span class="n">Start_Address</span><span class="o">=</span><span class="n">mode_register_address</span><span class="p">,</span>
                <span class="n">Data</span><span class="o">=</span><span class="n">register_value</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="s2">&quot;little&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">packet</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Failed to write register @</span><span class="si">%x</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mode_register_address</span><span class="p">,</span> <span class="n">packet</span><span class="o">.</span><span class="n">status_text</span><span class="p">)</span>

            <span class="n">engine</span><span class="o">.</span><span class="n">device_mode_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restart&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sending CPU Reset&quot;</span><span class="p">)</span>

            <span class="n">packet</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSG_CPU_Reset&quot;</span><span class="p">)</span>

    <span class="c1"># wait on a mode event for 1 sec</span>
    <span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">device_mode_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># default mode is any device mode</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">device_mode</span> <span class="o">==</span> <span class="n">mode</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Successfully restarted in </span><span class="si">%s</span><span class="s2"> mode&quot;</span> <span class="o">%</span> <span class="n">engine</span><span class="o">.</span><span class="n">device_mode</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Fail, restarted in </span><span class="si">%s</span><span class="s2"> instead of </span><span class="si">%s</span><span class="s2"> mode!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">device_mode</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Restarted in </span><span class="si">%s</span><span class="s2"> mode&quot;</span> <span class="o">%</span> <span class="n">engine</span><span class="o">.</span><span class="n">device_mode</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># no mode event timeout is accepted</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Mode changed, but no startup event received&quot;</span>
</pre></div>
</div>
</details>
<hr></section>
<section id="get-fw-headers">
<span id="proc-get-fw-headers"></span><h2><a class="reference internal" href="#get-fw-headers">get_fw_headers</a><a class="headerlink" href="#get-fw-headers" title="Link to this heading"></a></h2>
<blockquote>
<div><p>search and decode headers in page 3</p>
</div></blockquote>
<p><strong>API usage</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">blengine.hci.procedures.EMSystem</span> <span class="kn">import</span> <span class="n">get_fw_headers</span>

<span class="n">get_fw_headers</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">ihex_file</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="mi">3145728</span><span class="p">,</span> <span class="n">ihex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>CLI usage</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>blengine<span class="w"> </span>run<span class="w"> </span>get_fw_headers<span class="w"> </span><span class="o">[</span>-h<span class="o">]</span><span class="w"> </span><span class="o">[</span>-f<span class="w"> </span>IHEX_FILE<span class="o">]</span><span class="w"> </span><span class="o">[</span>-a<span class="w"> </span>ADDRESS<span class="o">]</span>
</pre></div>
</div>
<dl>
<dt>options:</dt><dd><dl class="option-list">
<dt><kbd><span class="option">-h</span>, <span class="option">--help</span></kbd></dt>
<dd><p>show this help message and exit</p>
</dd>
<dt><kbd><span class="option">-f <var>IHEX_FILE</var></span>, <span class="option">--ihex_file <var>IHEX_FILE</var></span></kbd></dt>
<dd><p>File to analyze</p>
</dd>
<dt><kbd><span class="option">-a <var>ADDRESS</var></span>, <span class="option">--address <var>ADDRESS</var></span></kbd></dt>
<dd><p>Start Address</p>
</dd>
</dl>
</dd>
</dl>
<details>
<summary><a>Show Procedure Source Code</a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_fw_headers</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">ihex_file</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="mh">0x00300000</span><span class="p">,</span> <span class="n">ihex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    search and decode headers in page 3</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">block_size</span> <span class="o">=</span> <span class="mh">0x1000</span>

    <span class="n">addr_start</span> <span class="o">=</span> <span class="n">address</span>

    <span class="n">addr_stop</span> <span class="o">=</span> <span class="n">address</span> <span class="o">+</span> <span class="mi">128</span> <span class="o">*</span> <span class="n">block_size</span>

    <span class="n">magic_bytes</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span><span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">])</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">current_page</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ihex_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ihex_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
            <span class="n">ihex</span> <span class="o">=</span> <span class="n">parse_ihex_file</span><span class="p">(</span><span class="n">fo</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ihex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ihex</span> <span class="o">=</span> <span class="p">{</span> <span class="n">x</span><span class="p">:</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ihex</span> <span class="p">}</span>
        <span class="n">address</span> <span class="o">=</span> <span class="mh">0x0</span>
        <span class="n">addr_stop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ihex</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">while</span> <span class="n">address</span> <span class="o">&lt;</span> <span class="n">addr_stop</span><span class="p">:</span>
        <span class="n">jump</span> <span class="o">=</span> <span class="n">block_size</span>
        <span class="n">tmp_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">current_page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="p">(</span> <span class="n">address</span> <span class="o">-</span> <span class="n">addr_start</span> <span class="p">)</span> <span class="o">/</span> <span class="mh">0x2000</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">ihex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmp_data</span> <span class="o">=</span> <span class="n">ihex</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSMM_Read_At_Address&quot;</span><span class="p">,</span> <span class="n">Start_Address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">Data_Length</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">tmp_data</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tmp_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="p">[</span> <span class="n">magic</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">length</span> <span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="s2">&quot;4sBB&quot;</span><span class="p">,</span> <span class="n">tmp_data</span><span class="p">[:</span><span class="mi">6</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">magic</span> <span class="o">==</span> <span class="n">magic_bytes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ihex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="n">tmp_data</span><span class="p">[:</span><span class="n">length</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSMM_Read_At_Address&quot;</span><span class="p">,</span> <span class="n">Start_Address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">Data_Length</span><span class="o">=</span><span class="n">length</span><span class="p">)</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">)</span>

                <span class="n">fw_header</span> <span class="o">=</span> <span class="n">fw_header_pkt</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                <span class="n">fw_header</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

                <span class="n">fw_crc</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">ihex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSG_Calculate_CRC32&quot;</span><span class="p">,</span>
                                <span class="n">Start_Address</span><span class="o">=</span><span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_start_addr&quot;</span><span class="p">),</span>
                                <span class="n">End_Address</span><span class="o">=</span><span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_start_addr&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_size&quot;</span><span class="p">)</span>
                            <span class="p">)</span>
                    <span class="n">fw_crc</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CRC32&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fw_crc</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">[</span><span class="n">length</span><span class="p">:</span><span class="n">length</span><span class="o">+</span><span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_size&quot;</span><span class="p">)])</span>

                <span class="n">fw_header</span> <span class="o">=</span> <span class="n">decode_fw_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fw_crc</span><span class="p">)</span>

                <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw_header</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                    <span class="n">section_code</span> <span class="o">=</span> <span class="n">SECTION_CODES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;section_code&quot;</span><span class="p">),</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>

                    <span class="n">fw_version</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_version&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                                            <span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_version&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="c1">#print(&quot;fw_flavor: %s, fw_stack&quot; % (fw_flavor, fw_stack))</span>

                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;╭─────────────────────────────&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Header at 0x</span><span class="si">%x</span><span class="s2"> (Page </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">current_page</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Version </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">version</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; CRC </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;header_crc_ctrl&quot;</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Length </span><span class="si">%s</span><span class="s2"> bytes&quot;</span> <span class="o">%</span> <span class="n">length</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; End at 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="n">length</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; --- Firmware Infos ---&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Type </span><span class="si">%s</span><span class="s2"> (0x</span><span class="si">%x</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">section_code</span><span class="p">,</span> <span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;section_code&quot;</span><span class="p">)))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Version </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fw_version</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Flavor </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">EMCORE_FLAVORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_flavor&quot;</span><span class="p">)),</span>
                            <span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_flavor&quot;</span><span class="p">))</span>
                            <span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Stack </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">HOST_STACK</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_stack&quot;</span><span class="p">)),</span>
                            <span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_stack&quot;</span><span class="p">))</span>
                            <span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Raw Options 0x</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_options&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; CRC </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_crc_ctrl&quot;</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Start at 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_start_addr&quot;</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Size </span><span class="si">%s</span><span class="s2"> bytes&quot;</span> <span class="o">%</span> <span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_size&quot;</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Exec addr 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_exec_addr&quot;</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; EMCore CRC 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;emcore_crc&quot;</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; End at 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_end_addr&quot;</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;╰─────────────────────────────&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="n">jump</span> <span class="o">=</span> <span class="n">length</span> <span class="o">+</span> <span class="n">fw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fw_size&quot;</span><span class="p">)</span>

        <span class="n">address</span> <span class="o">=</span> <span class="n">address</span> <span class="o">+</span> <span class="n">jump</span> <span class="o">-</span> <span class="p">(</span> <span class="n">address</span> <span class="o">%</span> <span class="n">block_size</span> <span class="p">)</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">headers</span>
</pre></div>
</div>
</details>
<hr></section>
<section id="get-rom-version">
<span id="proc-get-rom-version"></span><h2><a class="reference internal" href="#get-rom-version">get_rom_version</a><a class="headerlink" href="#get-rom-version" title="Link to this heading"></a></h2>
<blockquote>
<div><p>Get the ROM version informations.</p>
<p>This procedure will search in the nvm config files for a nvm_infos_addr and nvm_infos_crc32.
If thoses are found, it can then deduce the model and the device iteration from the nvm config file.
In any case it will parse the rom version as defined below :</p>
<blockquote>
<div><p>SET(FAB_VERSION         “revG”) # revision (max 4 characters)
SET(RELEASE_DATE        1323)   # date (i.e. W41 2022 = 4122)
SET(ROM_VERSION_MAJOR   4)      # ROM SW version 4.0
SET(ROM_VERSION_MINOR   0)      #
SET(ROM_GIT_TAG         “rom/v4.0”) # Git tag indicating this release (max 20 characters)</p>
</div></blockquote>
<p>This method return a dictionary.</p>
<p>The implementation is in platform.py (backward compatibility).</p>
</div></blockquote>
<p><strong>API usage</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">blengine.hci.procedures.EMSystem</span> <span class="kn">import</span> <span class="n">_get_rom_version</span>

<span class="n">_get_rom_version</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>CLI usage</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>No<span class="w"> </span>Help
</pre></div>
</div>
<details>
<summary><a>Show Procedure Source Code</a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_get_rom_version</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the ROM version informations.</span>

<span class="sd">    This procedure will search in the nvm config files for a nvm_infos_addr and nvm_infos_crc32.</span>
<span class="sd">    If thoses are found, it can then deduce the model and the device iteration from the nvm config file.</span>
<span class="sd">    In any case it will parse the rom version as defined below :</span>
<span class="sd">        SET(FAB_VERSION         &quot;revG&quot;) # revision (max 4 characters)</span>
<span class="sd">        SET(RELEASE_DATE        1323)   # date (i.e. W41 2022 = 4122)</span>
<span class="sd">        SET(ROM_VERSION_MAJOR   4)      # ROM SW version 4.0</span>
<span class="sd">        SET(ROM_VERSION_MINOR   0)      #</span>
<span class="sd">        SET(ROM_GIT_TAG         &quot;rom/v4.0&quot;) # Git tag indicating this release (max 20 characters)</span>

<span class="sd">    This method return a dictionary.</span>

<span class="sd">    The implementation is in platform.py (backward compatibility).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">restart</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">get_rom_version</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">raw</span><span class="p">)</span>
</pre></div>
</div>
</details>
<hr></section>
<section id="erase-main">
<span id="proc-erase-main"></span><h2><a class="reference internal" href="#erase-main">erase_main</a><a class="headerlink" href="#erase-main" title="Link to this heading"></a></h2>
<blockquote>
<div><p>Erase NVM Main Area</p>
</div></blockquote>
<p><strong>API usage</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">blengine.hci.procedures.EMSystem</span> <span class="kn">import</span> <span class="n">erase_main</span>

<span class="n">erase_main</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>CLI usage</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>No<span class="w"> </span>Help
</pre></div>
</div>
<details>
<summary><a>Show Procedure Source Code</a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@storage</span><span class="o">.</span><span class="n">procedure</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">erase_main</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Erase NVM Main Area</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">restart</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span>

    <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;EMSMM_NVM_Erase_Main&quot;</span><span class="p">)</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ok</span><span class="p">,</span> <span class="n">pkt</span><span class="o">.</span><span class="n">status_text</span>
</pre></div>
</div>
</details>
<hr><p>this page is auto generated by BLEngine/docs/procedures.py</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="EM9304commands.html" class="btn btn-neutral float-left" title="EM9304commands Procedures" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="authentication.html" class="btn btn-neutral float-right" title="authentication Procedures" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, EM Microelectronic.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>