

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>9305 Examples &mdash; BLEngine 1.10.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=1d24b1d9"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/js/search.js?v=a5c8da7a"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="HCI Packets List" href="../../packets.html" />
    <link rel="prev" title="9304 Examples" href="9304.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/logo_h_small.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Getting-Started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Usage.html">CLI Usage and options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Usage.html#blengine-commands">Blengine Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Usage.html#python-module-usage">Python Module Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NVM-Information.html">NVM Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HCI-Device-API.html">HCI Device API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Product-Lifecycle.html">Product Lifecycle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Releases-Notes.html">Releases Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="9304.html">9304 Examples</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">9305 Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#hex-file-programming-cli">HEX File Programming (CLI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#disable-sleep-mode">Disable Sleep Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#read-and-write-operations">Read and Write Operations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#direct-registers-read-and-write">Direct Registers Read and Write</a></li>
<li class="toctree-l3"><a class="reference internal" href="#direct-read-write">Direct Read/Write</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#simple-connection-script">Simple Connection Script</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../packets.html">HCI Packets List</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../procedures.html">BLEngine Procedures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/blengine.html">blengine package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BLEngine</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">9305 Examples</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="examples">
<h1>9305 Examples<a class="headerlink" href="#examples" title="Link to this heading"></a></h1>
<p>This page shows some examples of Python scripts to control a 9305 device.</p>
<p>For the following examples, it is assumed that a <code class="docutils literal notranslate"><span class="pre">9305</span></code> device is declared in the configuration file <code class="docutils literal notranslate"><span class="pre">config_local.cfg</span></code>, like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">9305</span><span class="p">]</span>
<span class="n">port</span> <span class="o">=</span> <span class="n">COMxx</span>
<span class="o">...</span>
</pre></div>
</div>
<p>However, if a default device has been defined, then the option <code class="docutils literal notranslate"><span class="pre">--device=9305</span></code> can be skipped.</p>
<section id="hex-file-programming-cli">
<h2>HEX File Programming (CLI)<a class="headerlink" href="#hex-file-programming-cli" title="Link to this heading"></a></h2>
<p>The two commands below are needed only if something has already been programmed in NVM. Their goal is to enter into the configuration mode and to erase the flash memory main area (the information pages are not erased).
It is also possible to enter into the configuration mode also by issuing a Power On Reset while toggling GPIO5 at a frequency of 32 kHz.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">blengine_cli</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">config</span> <span class="n">config</span><span class="o">.</span><span class="n">cfg</span> <span class="o">--</span><span class="n">device</span> <span class="mi">9305</span> <span class="n">send</span> <span class="n">EMSG_Enter_Configuration_Mode</span>
<span class="n">python</span> <span class="n">blengine_cli</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">config</span> <span class="n">config</span><span class="o">.</span><span class="n">cfg</span> <span class="o">--</span><span class="n">device</span> <span class="mi">9305</span> <span class="n">send</span> <span class="n">EMSMM_NVM_Erase_Main</span>
</pre></div>
</div>
<p>Then the firmware image can be programmed by using the command below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">blengine_cli</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">config</span> <span class="n">config</span><span class="o">.</span><span class="n">cfg</span> <span class="o">--</span><span class="n">device</span> <span class="mi">9305</span> <span class="n">run</span> <span class="n">emsystem_prog</span> <span class="n">xxx_nvm_main</span><span class="o">.</span><span class="n">ihex</span>
</pre></div>
</div>
<p>Note that the file to be programmed shall be in the Intel Hex format.</p>
<p>Once done, reset the device to start executing the NVM Application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">blengine_cli</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">config</span> <span class="n">config</span><span class="o">.</span><span class="n">cfg</span> <span class="o">--</span><span class="n">device</span> <span class="mi">9305</span> <span class="n">send</span> <span class="n">EMSG_Leave_Configuration_Mode</span>
</pre></div>
</div>
</section>
<section id="disable-sleep-mode">
<h2>Disable Sleep Mode<a class="headerlink" href="#disable-sleep-mode" title="Link to this heading"></a></h2>
<p>In order to disable the Sleep Mode, the command <code class="docutils literal notranslate"><span class="pre">EMSG_Set_Sleep_Options</span></code> shall be sent to the EM9305 with a UINT8 parameter set to 0x00.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">blengine_cli</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">config</span> <span class="n">config</span><span class="o">.</span><span class="n">cfg</span> <span class="o">--</span><span class="n">device</span> <span class="mi">9305</span> <span class="n">send</span> <span class="n">EMSG_Set_Sleep_Options</span> <span class="o">--</span><span class="n">Sleep_Options</span><span class="o">=</span><span class="mh">0x00</span>
</pre></div>
</div>
<p>The parameter’s value 0x00 instructs the device to disable the automatic switch to sleep mode while the parameter set to 0x01 instructs the device to enable the automatic switch. Consequently, by using this command and playing with this parameter, it is possible to enable or disable the automatic switch to sleep mode.</p>
<p><strong>Note</strong>: It is important to specify any hexadecimal value with a leading 0 when the value itself is less that 0x10. There might be sometimes a misinterpretation if such condition is not fulfilled. This is why the two values 0 and 1 exposed in the above example are written <code class="docutils literal notranslate"><span class="pre">0x00</span></code> and <code class="docutils literal notranslate"><span class="pre">0x01</span></code>.</p>
</section>
<section id="read-and-write-operations">
<h2>Read and Write Operations<a class="headerlink" href="#read-and-write-operations" title="Link to this heading"></a></h2>
<section id="direct-registers-read-and-write">
<h3>Direct Registers Read and Write<a class="headerlink" href="#direct-registers-read-and-write" title="Link to this heading"></a></h3>
<p>It is possible de read from/write to device registers through the dedicated commands <code class="docutils literal notranslate"><span class="pre">emsmm_write_register</span></code> and <code class="docutils literal notranslate"><span class="pre">emsmm_read_register</span></code>.</p>
<p><strong>WARNING</strong>: All hexadecimal values in these examples shall be entered in the big endian notation. Even if the 9305 ARC core CPU implementation is in little endian, this can be confusing so the following procedures automatically takes care of the inversion so the user does not have to bother.</p>
<p>The first argument is the register address and the second is the new value.</p>
<p>Here is an example for configuring some GPIOs as input and some others as output. The first hexadecimal value is the register address and the second one is the register configuration.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">blengine_cli</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">device</span> <span class="mi">9305</span> <span class="n">run</span> <span class="n">emsmm_write_register</span> <span class="mh">0xF03400</span> <span class="mh">0x03</span>
<span class="n">python</span> <span class="n">blengine_cli</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">device</span> <span class="mi">9305</span> <span class="n">run</span> <span class="n">emsmm_write_register</span> <span class="mh">0xF03404</span> <span class="mh">0x0C</span>
</pre></div>
</div>
<p>The register at address 0xF03400 is used to select which GPIOs are configured as input. The register at address 0xF03404 is used to select which GPIOs are configured as output. And in both registers, bit 0 controls GPIO0 configuration, bit 1 controls GPIO1 configuration and so on.</p>
<p>Consequently in this example, the GPIO0 and GPIO1 are configured as input while GPIO2 and GPIO3 are configured as output.</p>
<p><strong>WARNING</strong>: Writing directly into the device registers can lead to the device malfunction and should be used with care.</p>
</section>
<section id="direct-read-write">
<h3>Direct Read/Write<a class="headerlink" href="#direct-read-write" title="Link to this heading"></a></h3>
<p>It is also possible to use the generic procedures <code class="docutils literal notranslate"><span class="pre">emsmm_read_at_address</span></code> and <code class="docutils literal notranslate"><span class="pre">emsmm_write_at_address</span></code> to achieve the same goal than exposed above. Thus, these commands extend the device access to the other memories like the ROM, the RAM and the flash memory, not only the registers.</p>
<p><strong>NOTE</strong>: The <code class="docutils literal notranslate"><span class="pre">emsmm_write_at_address</span></code> command will obviously fail when used to write on a non writable memory like the ROM or in the flash memory.</p>
<p>The following example shows a command that can be used to read trimming information (4 bytes).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">blengine_cli</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">config</span> <span class="n">config</span><span class="o">.</span><span class="n">cfg</span> <span class="o">--</span><span class="n">device</span> <span class="mi">9305</span> <span class="n">send</span> <span class="n">EMSMM_Read_At_Address</span> <span class="o">--</span><span class="n">Start_Address</span><span class="o">=</span><span class="mh">0xF00428</span> <span class="o">--</span><span class="n">Data_Length</span><span class="o">=</span><span class="mi">4</span>
</pre></div>
</div>
<p>And the following command can be used to write trimming information (0x06929f0f). Note that unlike the register access functions that take care of the data endianness, the data here shall be a byte array in which the data are provided in little endian. In such notation, the least significant byte (LSB) is given first, and the most significant byte (MSB) is given last.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">blengine_cli</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">config</span> <span class="n">config</span><span class="o">.</span><span class="n">cfg</span> <span class="o">--</span><span class="n">device</span> <span class="mi">9305</span> <span class="n">send</span> <span class="n">EMSMM_Write_At_Address</span> <span class="o">--</span><span class="n">Start_Address</span><span class="o">=</span><span class="mh">0x00F00428</span> <span class="o">--</span><span class="n">Data</span><span class="o">=</span><span class="s2">&quot;bytearray([0x0f, 0x9f, 0x92, 0x06])&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">-–Data</span></code> argument is evaluated by the python interpreter so it is possible to inject python code here.</p>
</section>
</section>
<section id="simple-connection-script">
<h2>Simple Connection Script<a class="headerlink" href="#simple-connection-script" title="Link to this heading"></a></h2>
<p>This example assumes that there are two BLE devices both connected to the host computer on which the BLEngine based application is running as shown in the figure below:</p>
<p><img alt="Connection testing script" src="../../_images/simple_connection_script_scheme.drawio.png" /></p>
<p>It assumes that there are a <code class="docutils literal notranslate"><span class="pre">DUT</span></code> device and a <code class="docutils literal notranslate"><span class="pre">LOWER_TESTER</span></code> device declared in the configuration file so they can be accessed by using their friendly name.</p>
<p>Thus, the two BLE devices can be either a 9304 or a 9305 chips.</p>
<p><strong>NOTE</strong>: For 9305, the link layer must be programmed in the NVM (e.g., <code class="docutils literal notranslate"><span class="pre">&lt;SDK_PATH&gt;/projects/nvm_bluetooth_controller/</span></code>)</p>
<p><strong>NOTE</strong>: For 9304, it is recommended to program the latest metapatch.</p>
<p>The script below shows the test that is done.
It does the following operations:</p>
<ol class="arabic simple">
<li><p>configures the DUT to start advertising</p></li>
<li><p>activates the scan process on the lower tester for a default duration of 5 seconds</p></li>
<li><p>stop scan process</p></li>
<li><p>for each scanned device (the DUT and all other devices in the vicinity), open a connection</p></li>
<li><p>check the connected state</p></li>
<li><p>for connected devices, disconnect</p></li>
<li><p>shows up a message indicating how many connection succeeded</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="kn">from</span> <span class="nn">blengine</span> <span class="kn">import</span> <span class="n">enable_cli_args</span><span class="p">,</span> <span class="n">default_parser</span>
<span class="kn">from</span> <span class="nn">blengine.core.config</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">load</span>
<span class="kn">from</span> <span class="nn">blengine.core</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">blengine.core.config</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">load</span>
<span class="kn">from</span> <span class="nn">blengine.hci.engine</span> <span class="kn">import</span> <span class="n">HciEngine</span>
<span class="kn">from</span> <span class="nn">blengine.core.transport</span> <span class="kn">import</span> <span class="n">SerialTransport</span><span class="p">,</span> <span class="n">serial_from_config</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This example buld a addresses list from advertising packets and try connecting to each devices</span>

<span class="sd">python ./examples/basic/helloScanConnect.py --config=../config.cfg --scan_duration=3</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="c1"># For fun and profit, we add a new arguments for cli.</span>
<span class="n">default_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--scan_duration&#39;</span><span class="p">,</span> <span class="s1">&#39;-scan&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;scan duration in seconds&#39;&#39;&#39;</span><span class="p">)</span>
<span class="c1"># Process the command line arguments.</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">enable_cli_args</span><span class="p">()</span>

<span class="n">logger</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s2">&quot;HelloScanConnect&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">to_screen</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">LE_scan</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>

    <span class="c1"># Create an object on the upcoming events.</span>
    <span class="n">isScanFinished</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="c1"># Create a list of devices. This script can handle more than one DUTs.</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Timing might be an important information.</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">register_device</span><span class="p">(</span><span class="n">pkt</span><span class="p">):</span>
        <span class="c1"># If the scan is not finished (&lt;5 seconds) and an advertising packet has been</span>
        <span class="c1"># received, add the originator device address along with the received packet.</span>
        <span class="c1"># Otherwise do nothing.</span>
        <span class="k">if</span> <span class="n">isScanFinished</span><span class="o">.</span><span class="n">isSet</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Event_Type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;found &quot;</span> <span class="o">+</span> <span class="n">pkt</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">update</span><span class="p">({</span> <span class="n">pkt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">():</span> <span class="n">pkt</span> <span class="p">})</span>

            <span class="c1"># Check if the scan duration has elapsed. If yes, then stop the scan process.</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">args</span><span class="o">.</span><span class="n">scan_duration</span><span class="p">:</span>
                <span class="n">isScanFinished</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="s2">&quot;on_LE_Advertising_Report&quot;</span><span class="p">)</span>

    <span class="c1"># For each received advertising report, call the callback function defined above.</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;on_LE_Advertising_Report&quot;</span><span class="p">,</span> <span class="n">register_device</span><span class="p">)</span>

    <span class="c1"># Configure the scan process.</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;LE_Set_Scan_Parameters&quot;</span><span class="p">,</span> 
            <span class="n">LE_Scan_Type</span><span class="o">=</span><span class="mh">0x01</span><span class="p">,</span>
            <span class="n">LE_Scan_Interval</span><span class="o">=</span><span class="mh">0x0030</span><span class="p">,</span>
            <span class="n">LE_Scan_Window</span><span class="o">=</span><span class="mh">0x0030</span>
    <span class="p">)</span>

    <span class="c1"># Start scanning the BLE environment.</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;LE_Set_Scan_Enable&quot;</span><span class="p">,</span>
        <span class="n">LE_Scan_Enable</span><span class="o">=</span><span class="mh">0x01</span><span class="p">,</span>
        <span class="n">Filter_Duplicates</span><span class="o">=</span><span class="mh">0x01</span><span class="p">,</span>
        <span class="n">wait_ack</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    
    <span class="c1"># Add extra time (1 s) to process all received advertising (ADV) packets.</span>
    <span class="n">isScanFinished</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">scan_duration</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Disable the scan.</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;LE_Set_Scan_Enable&quot;</span><span class="p">,</span>
        <span class="n">LE_Scan_Enable</span><span class="o">=</span><span class="mh">0x00</span><span class="p">,</span>
        <span class="n">Filter_Duplicates</span><span class="o">=</span><span class="mh">0x01</span>
    <span class="p">)</span>

    <span class="c1"># And return the list of scanned devices.</span>
    <span class="k">return</span> <span class="n">devices</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">serial</span>

    <span class="c1"># Instanciate the transport to the DUT.</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="n">serial_from_config</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;DUT&#39;</span><span class="p">])</span>

    <span class="n">connectables</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">is_connected</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">connected_device</span><span class="p">(</span><span class="n">pkt</span><span class="p">):</span>
        <span class="c1"># Print the packet.</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>
        <span class="c1"># Usually, when receiving the &quot;connection complete&quot; event means that the connection is</span>
        <span class="c1"># completed. However, as a general rule, check if connection status field is 0 (new </span>
        <span class="c1"># connection succeeded) or 0xb (connection already established).</span>
        <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">]:</span>
            <span class="n">is_connected</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="c1"># Instanciate the HCI engine ngine</span>
    <span class="k">with</span> <span class="n">HciEngine</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span> <span class="k">as</span> <span class="n">engine</span><span class="p">:</span>
        <span class="c1"># Set the callback when an event &quot;connection complete&quot; is received.</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;on_LE_Connection_Complete&quot;</span><span class="p">,</span> <span class="n">connected_device</span><span class="p">)</span>

        <span class="c1"># Debug statements. Log all TX and RX packets. This can be useful.</span>
        <span class="c1"># engine.bind(&quot;on_tx&quot;, lambda pkt: logger.root().info(&quot;TX&quot; + str(pkt)))</span>
        <span class="c1"># engine.bind(&quot;on_rx&quot;, lambda pkt: logger.root().info(&quot;RX&quot; + str(pkt)))</span>

        <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Reset&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start scan&quot;</span><span class="p">)</span>
        
        <span class="c1"># Start scanning...</span>
        <span class="n">devices</span> <span class="o">=</span> <span class="n">LE_scan</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

        <span class="c1"># When we reach this point, the scan is completed.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;stop scan&quot;</span><span class="p">)</span>

        <span class="c1"># Display number of devices found.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;found </span><span class="si">%s</span><span class="s2"> devices:&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">devices</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
            
            <span class="c1"># Try to connect to each found device.</span>
            <span class="n">pkt</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;LE_Create_Connection&quot;</span><span class="p">,</span> 
                                    <span class="n">LE_Scan_Interval</span> <span class="o">=</span> <span class="mh">0x0030</span><span class="p">,</span>
                                    <span class="n">LE_Scan_Window</span> <span class="o">=</span> <span class="mh">0x0030</span><span class="p">,</span>
                                    <span class="n">Initiator_Filter_Policy</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
                                    <span class="n">Peer_Address_Type</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
                                    <span class="n">Peer_Address</span> <span class="o">=</span> <span class="n">d</span><span class="p">,</span>
                                    <span class="n">Own_Address_Type</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
                                    <span class="n">Connection_Interval_Min</span> <span class="o">=</span> <span class="mh">0x00AA</span><span class="p">,</span>
                                    <span class="n">Connection_Interval_Max</span> <span class="o">=</span> <span class="mh">0x00AA</span><span class="p">,</span>
                                    <span class="n">Connection_Latency</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                    <span class="n">Supervision_Timeout</span> <span class="o">=</span> <span class="mh">0x01f4</span><span class="p">,</span>
                                    <span class="n">Min_CE_Length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                    <span class="n">Max_CE_Length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                    <span class="n">wait_ack</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">retry</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

            <span class="c1"># Wait two seconds. During these two seconds, the connection might complete. In such </span>
            <span class="c1"># a case, an event &quot;LE_Connection_complete&quot; is received and the callback function</span>
            <span class="c1"># &quot;connected_device&quot; is called. This function will then test the connection status field</span>
            <span class="c1"># in the received packet and add the new device in the list of connected devices.</span>
            <span class="n">connected</span> <span class="o">=</span> <span class="n">is_connected</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">connected</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Connection Success&quot;</span> <span class="o">%</span> <span class="n">d</span><span class="p">)</span>
                <span class="c1"># Add the device in the list of connected devices.</span>
                <span class="n">connectables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="c1"># Then disconnect.</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Disconnect&quot;</span><span class="p">,</span> <span class="n">Connection_Handle</span><span class="o">=</span><span class="n">pkt</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Connection_Handle&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Connection Fail&quot;</span> <span class="o">%</span> <span class="n">d</span><span class="p">)</span>

            <span class="c1"># Clear the &quot;connected&quot; event flag, for the next device.</span>
            <span class="n">is_connected</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">connectables</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connectables Devices : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">connectables</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no connectables devices&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="9304.html" class="btn btn-neutral float-left" title="9304 Examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../packets.html" class="btn btn-neutral float-right" title="HCI Packets List" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, EM Microelectronic.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>