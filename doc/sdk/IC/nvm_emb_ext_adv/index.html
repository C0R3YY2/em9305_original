<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EM EMB Extended Advertisement Example &mdash; EM9305 4.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=665bc78d" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=0cd558ae"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Heart Rate Service EMB Lite Sample Application" href="../nvm_emb_lite_hrs/index.html" />
    <link rel="prev" title="Tx Power Control Example" href="../nvm_emb_power_control/index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/logo_h_small.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../ReleaseNotes.html">emb Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sections/GettingStarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sections/MigrationGuide.html">Migration guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sections/IDEIntegration.html">MetaWare IDE Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sections/CMakeBuild.html">CMake and build procedure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sections/rom.html">ROM Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sections/Bluetooth.html">Bluetooth</a></li>
<li class="toctree-l1"><a class="reference internal" href="../emcore/index.html">EM-Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sections/FirmwareUpdate.html">Firmware Update</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sections/Lifecycle.html">EM9305 Lifecycle Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API.html">API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../Examples.html">Sample Applications</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../examples/drivers.html">EM9305 Drivers</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../examples/bluetooth.html">Bluetooth Sample Applications</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../nvm_emb_controller/index.html">Bluetooth controller example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nvm_emb_datatransfer_server/index.html">EM EMB Data Transfer Server service Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nvm_emb_datatransfer_client/index.html">EM EMB Data Transfer Service Client Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nvm_emb_fit/index.html">FIT example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nvm_emb_hrs/index.html">Heart Rate Service (HRS) example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nvm_emb_rpa/index.html">Resolvable Private Address (RPA) example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nvm_emb_tag/index.html">TagConnected example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nvm_emb_assettag/index.html">Asset Tag example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nvm_emb_ancs_client/index.html">ANCS Client Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nvm_emb_power_control/index.html">Tx Power Control Example</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">EM EMB Extended Advertisement Example</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setup">Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#library">Library</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation-details">Implementation details</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build">Build</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run">Run</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../nvm_emb_lite_hrs/index.html">Heart Rate Service EMB Lite Sample Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nvm_emb_audio_control/index.html">LE Audio Control example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples/firmware_update.html">Firmware Update Sample Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/misc.html">Miscellaneous Sample Applications</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../sections/Links.html">Links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sections/ApplicationNotes.html">Application Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sections/HowTo.html">How to</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sections/FAQ.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sections/Limitations.html">Known limitations &amp; constraints</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">EM9305</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../Examples.html">Sample Applications</a></li>
          <li class="breadcrumb-item"><a href="../examples/bluetooth.html">Bluetooth Sample Applications</a></li>
      <li class="breadcrumb-item active">EM EMB Extended Advertisement Example</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="em-emb-extended-advertisement-example">
<h1>EM EMB Extended Advertisement Example<a class="headerlink" href="#em-emb-extended-advertisement-example" title="Link to this heading"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>The purpose of this example is to demonstrate how the extended Advertisement works and how to set it up.
The local device runs the example application software on the EM9305.</p>
<p>This example will configure the device with the peripheral role in which the device will do the following:</p>
<ol class="arabic simple">
<li><p>perform extended advertising, waiting for incoming connections</p></li>
<li><p>answer to connection requests</p></li>
</ol>
<p>This advertising allows a device acting with the central role to be aware of the peripheral device presence, and then to initiate an incoming connection that the peripheral can accept.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This application has configurable SMP parameters <cite>smpCfg_t</cite> where <cite>minKeyLen</cite> can be specified. Reducing this value from 16 to 7 (minimum) reduces the entropy of the encryption key making the device less secure.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>While this example does setup the SMP subsystem, it does not support pairing. For an example that supports pairing, please see nvm_emb_fit.</p>
</div>
</section>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Link to this heading"></a></h2>
<p>In this setup, a central device can scan for EM9305 running the <cite>nvm_emb_ext_adv</cite> example. A connection can be initiated from the central after it scans and finds the peripheral.
Customer can further develop their application and also add different custom/proprietary or SIG defined profiles and services to the extended advertisements.</p>
</section>
<section id="library">
<h2>Library<a class="headerlink" href="#library" title="Link to this heading"></a></h2>
<p>This example uses the <cite>emb_peripheral_advext</cite> library, which allows for the use of advertising extensions in the peripheral role.</p>
</section>
<section id="implementation-details">
<h2>Implementation details<a class="headerlink" href="#implementation-details" title="Link to this heading"></a></h2>
<p>The <em>nvm_main.c</em> file contains code that creates and starts tasks for the Bluetooth Low Energy and the application.</p>
<p>The <em>my_app/includes/my_app_signals.h</em> file contains the signals that are used by the whole application (between tasks and internally).</p>
<p>The <em>my_app/includes/my_app_task.h</em> file contains the interface to create, start and post events to the application task.</p>
<p>The <em>my_app/source/my_app_task.c</em> file contains the implementation to create, start and post events to the application task.</p>
<p>The <em>my_app/source/my_app.c</em> file contains the internal and external event processing for the application task.</p>
<p>The <em>my_app/source/my_app.h</em> file contains the protected interface to be used by <em>my_app_task.c</em>.</p>
<p>The <em>ble/includes/ble_task.h</em> file contains the interface to create, start and post events to the BLE task.</p>
<p>The <em>ble/source/ble_task.c</em> file contains the implementation to create, start and post events to the BLE task.</p>
<p>The <em>ble/source/ble.c</em> file contains the internal and external event processing for the BLE task.</p>
<p>The <em>ble/source/ble.h</em> file contains the protected interface to be used by <em>ble_task.c</em>.</p>
<p>Configuring the extended advertising is done by setting all relevant values in the <cite>appExtAdvCfg_t</cite> structure as show below in ble.c file:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">appExtAdvCfg_t</span><span class="w"> </span><span class="n">gcAppExtAdvCfg</span><span class="w"> </span><span class="o">=</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w">     </span><span class="c1">// Advertise forever (no time limitation)</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="mi">160</span><span class="p">},</span><span class="w">   </span><span class="c1">// 100 ms extended advertising period (160 * 0.625 ms)</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w">     </span><span class="c1">// No maximum number of extended adv events before terminating advertising</span>
<span class="w">    </span><span class="p">{</span><span class="nb">false</span><span class="p">},</span><span class="w">  </span><span class="c1">// Do not use legacy advertising (limited to 31 bytes in size)</span>
<span class="w">    </span><span class="p">{</span><span class="mi">160</span><span class="p">}</span><span class="w">     </span><span class="c1">// 200 ms of legacy advertising (160 * 1.25 ms) in case it is used</span>
<span class="p">};</span>
</pre></div>
</div>
<p>This structure is used later in the code during the initialization process to configure the extended advertising.</p>
<p>The BLE stack is initialized through a callback passed in <cite>WsfOsRegisterTaskInitCback()</cite> when the BLE Task is started.
It is inside this function that the above mentioned structure is used to feed the BLE stack with the configuration data it contains.
This is done by setting a reserved dedicated pointer (<cite>pAppExtAdvCfg</cite>) to the address of this structure, like shown below:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">BLE_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// Configure extended advertising by initializing the reserved pointer &#39;pAppExtAdvCfg&#39;.</span>
<span class="w">  </span><span class="n">pAppExtAdvCfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">appExtAdvCfg_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gcAppExtAdvCfg</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Other initialization code here</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As an example, the following code snippet sets the device local name to <cite>EMB EXT ADV</cite>. It calls the function <cite>AppExtAdvSetAdValue()</cite> passing a structure containing the device name as an argument.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* device name */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">gAdvDevName</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span>
<span class="p">{</span>
<span class="w">    </span><span class="sc">&#39;E&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="sc">&#39;M&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="sc">&#39;B&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="sc">&#39; &#39;</span><span class="p">,</span>
<span class="w">    </span><span class="sc">&#39;E&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="sc">&#39;X&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="sc">&#39;T&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="sc">&#39; &#39;</span><span class="p">,</span>
<span class="w">    </span><span class="sc">&#39;A&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="sc">&#39;D&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="sc">&#39;V&#39;</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">BLE_SetupAdv</span><span class="p">(</span><span class="n">appMsg_t</span><span class="w"> </span><span class="o">*</span><span class="n">pMsg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// Set the device local name as a data that can be discovered over BLE.</span>
<span class="w">  </span><span class="n">AppExtAdvSetData</span><span class="p">(</span>
<span class="w">    </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">DM_ADV_HANDLE_DEFAULT</span><span class="p">,</span>
<span class="w">    </span><span class="n">DM_ADV_TYPE_LOCAL_NAME</span><span class="p">,</span>
<span class="w">    </span><span class="k">sizeof</span><span class="p">(</span><span class="n">gAdvDevName</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gAdvDevName</span><span class="p">);</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Other characteristics initialization follow...</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Other characteristics can be written at this stage within the <cite>BLE_SetupAdv()</cite> function, but it shall be noted that this is done only once after a device power on reset or after a device manager reset.
To use the full available payload length of the extended advertising data, the manufacturing data is filled with raw data in the sample application. The first 2 bytes indicate the vendor ID of the company.</p>
</div>
</section>
<section id="build">
<h2>Build<a class="headerlink" href="#build" title="Link to this heading"></a></h2>
<p>The build target of this example is: <strong>nvm_emb_ext_adv</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>&lt;sdk&gt;<span class="se">\b</span>uild
cmake<span class="w"> </span>--build<span class="w"> </span>.<span class="w"> </span>--target<span class="w"> </span>nvm_emb_ext_adv
</pre></div>
</div>
</section>
<section id="run">
<h2>Run<a class="headerlink" href="#run" title="Link to this heading"></a></h2>
<p>To program and run the example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>&lt;sdk&gt;<span class="se">\t</span>ools<span class="se">\b</span>lengine
python<span class="w"> </span>blengine_cli.py<span class="w"> </span>--port<span class="w"> </span>COMYY<span class="w"> </span>run<span class="w"> </span>emsystem_prog<span class="w"> </span>..<span class="se">\.</span>.<span class="se">\b</span>uild<span class="se">\p</span>rojects<span class="se">\n</span>vm_emb_ext_adv<span class="se">\n</span>vm_emb_ext_adv.ihex<span class="w"> </span>--progress
</pre></div>
</div>
<p>With YY = the COM port number used to program your DVK (the one connected to BRG_USB port).</p>
<p>Then you can connect to the device named <cite>EMB_EXT_ADV</cite> using your preferred smartphone or tablet application.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../nvm_emb_power_control/index.html" class="btn btn-neutral float-left" title="Tx Power Control Example" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../nvm_emb_lite_hrs/index.html" class="btn btn-neutral float-right" title="Heart Rate Service EMB Lite Sample Application" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023-2024, EM Microelectronic.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>